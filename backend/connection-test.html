<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Test - Saathi TV</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }
        
        .test-btn {
            background: #FF6B35;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            background: #F7931E;
            transform: translateY(-2px);
        }
        
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        video {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 10px;
            border: 2px solid #ddd;
        }
        
        .status-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
        }
        
        .login-form {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        
        .age-check {
            margin: 15px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        .age-check label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        h2 {
            color: #333;
            border-bottom: 2px solid #FF6B35;
            padding-bottom: 10px;
        }
        
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .log-success { background: #d4edda; color: #155724; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-warning { background: #fff3cd; color: #856404; }
        .log-info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üîß Saathi TV Connection Test</h1>
    
    <div class="test-container">
        <h2>1. Age Confirmation Test</h2>
        <div class="age-check">
            <label>
                <input type="checkbox" id="ageConfirm"> 
                I confirm that I am at least 18 years old
            </label>
        </div>
        <button class="test-btn" onclick="testAgeConfirmation()">Test Age Check</button>
        <div id="ageResult"></div>
    </div>

    <div class="test-container">
        <h2>2. Google Login Test</h2>
        <button type="button" id="googleLogin" class="test-btn">
            <i class="fab fa-google"></i>
            <span>Continue with Google</span>
        </button>
        <div id="googleResult"></div>
    </div>

    <div class="test-container">
        <h2>3. Socket.io Connection Test</h2>
        <button class="test-btn" onclick="testSocketConnection()">Test Socket Connection</button>
        <button class="test-btn" onclick="disconnectSocket()">Disconnect Socket</button>
        <div id="socketResult"></div>
    </div>

    <div class="test-container">
        <h2>4. WebRTC Media Test</h2>
        <button class="test-btn" onclick="testMediaDevices()">Test Camera & Microphone</button>
        <button class="test-btn" onclick="stopMediaDevices()">Stop Media</button>
        <div class="video-container">
            <div>
                <h4>Local Video</h4>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            <div>
                <h4>Remote Video</h4>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>
        <div id="mediaResult"></div>
    </div>

    <div class="test-container">
        <h2>5. WebRTC Peer Connection Test</h2>
        <button class="test-btn" onclick="testPeerConnection()">Create Peer Connection</button>
        <button class="test-btn" onclick="simulateRemoteUser()">Simulate Remote User</button>
        <button class="test-btn" onclick="closePeerConnection()">Close Connection</button>
        <div id="peerResult"></div>
    </div>

    <div class="test-container">
        <h2>6. Complete Integration Test</h2>
        <button class="test-btn" onclick="runCompleteTest()">Run Full Test</button>
        <button class="test-btn" onclick="clearAllTests()">Clear All Results</button>
        <div id="integrationResult"></div>
    </div>

    <div class="test-container">
        <h2>7. Live Console Logs</h2>
        <button class="test-btn" onclick="clearLogs()">Clear Logs</button>
        <div id="logContainer" class="log-container"></div>
    </div>

    <!-- Status Display -->
    <div id="connectionStatus" class="status-display">
        Initializing tests...
    </div>

    <!-- Load Required Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/connection-fix.js"></script>

    <script>
        // Test Variables
        let testSocket = null;
        let testPeerConnection = null;
        let testLocalStream = null;
        let testRemoteStream = null;
        let logs = [];

        // Console logging override
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.join(' ');
            logs.push({ type, timestamp, message });
            updateLogDisplay();
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('info', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('error', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('warning', ...args);
        };

        function updateLogDisplay() {
            const container = document.getElementById('logContainer');
            container.innerHTML = logs.slice(-50).map(log => 
                `<div class="log-entry log-${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            logs = [];
            updateLogDisplay();
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = message;
            statusElement.className = `status-display ${type}`;
        }

        // Test Functions
        function testAgeConfirmation() {
            const ageCheckbox = document.getElementById('ageConfirm');
            
            if (ageCheckbox.checked) {
                showResult('ageResult', '‚úÖ Age confirmation working correctly', 'success');
                console.log('‚úÖ Age confirmation test passed');
            } else {
                showResult('ageResult', '‚ùå Please check the age confirmation checkbox first', 'error');
                console.log('‚ùå Age confirmation test failed');
            }
        }

        function testSocketConnection() {
            try {
                console.log('üîå Testing Socket.io connection...');
                showResult('socketResult', 'üîÑ Connecting to server...', 'info');

                if (typeof io === 'undefined') {
                    throw new Error('Socket.io not loaded');
                }

                testSocket = io({
                    transports: ['websocket', 'polling'],
                    timeout: 10000
                });

                testSocket.on('connect', () => {
                    console.log('‚úÖ Socket connected:', testSocket.id);
                    showResult('socketResult', `‚úÖ Socket connected successfully<br>Socket ID: ${testSocket.id}`, 'success');
                    updateStatus('Socket Connected', 'success');
                });

                testSocket.on('disconnect', (reason) => {
                    console.log('‚ùå Socket disconnected:', reason);
                    showResult('socketResult', `‚ùå Socket disconnected: ${reason}`, 'error');
                    updateStatus('Socket Disconnected', 'error');
                });

                testSocket.on('connect_error', (error) => {
                    console.error('‚ùå Socket connection error:', error);
                    showResult('socketResult', `‚ùå Connection failed: ${error.message}`, 'error');
                    updateStatus('Connection Error', 'error');
                });

            } catch (error) {
                console.error('‚ùå Socket test error:', error);
                showResult('socketResult', `‚ùå Socket test failed: ${error.message}`, 'error');
            }
        }

        function disconnectSocket() {
            if (testSocket) {
                testSocket.disconnect();
                testSocket = null;
                console.log('üîå Socket disconnected manually');
                showResult('socketResult', 'üîå Socket disconnected manually', 'warning');
            }
        }

        async function testMediaDevices() {
            try {
                console.log('üé• Testing media devices...');
                showResult('mediaResult', 'üîÑ Requesting camera and microphone access...', 'info');

                // Check available devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioDevices = devices.filter(device => device.kind === 'audioinput');

                console.log(`üìπ Video devices found: ${videoDevices.length}`);
                console.log(`üé§ Audio devices found: ${audioDevices.length}`);

                // Request user media
                const constraints = {
                    video: videoDevices.length > 0 ? {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } : false,
                    audio: audioDevices.length > 0 ? {
                        echoCancellation: true,
                        noiseSuppression: true
                    } : false
                };

                testLocalStream = await navigator.mediaDevices.getUserMedia(constraints);

                // Display local video
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = testLocalStream;

                console.log('‚úÖ Media devices access granted');
                showResult('mediaResult', 
                    `‚úÖ Media access successful<br>
                    üìπ Video devices: ${videoDevices.length}<br>
                    üé§ Audio devices: ${audioDevices.length}<br>
                    üé¨ Stream tracks: ${testLocalStream.getTracks().length}`, 
                    'success'
                );
                updateStatus('Media Ready', 'success');

            } catch (error) {
                console.error('‚ùå Media devices error:', error);
                let errorMessage = 'Failed to access media devices. ';
                
                switch (error.name) {
                    case 'NotAllowedError':
                        errorMessage += 'Permission denied. Please allow camera/microphone access.';
                        break;
                    case 'NotFoundError':
                        errorMessage += 'No camera or microphone found.';
                        break;
                    case 'NotReadableError':
                        errorMessage += 'Camera/microphone is being used by another application.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showResult('mediaResult', `‚ùå ${errorMessage}`, 'error');
                updateStatus('Media Error', 'error');
            }
        }

        function stopMediaDevices() {
            if (testLocalStream) {
                testLocalStream.getTracks().forEach(track => track.stop());
                testLocalStream = null;
                
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = null;
                
                console.log('üõë Media devices stopped');
                showResult('mediaResult', 'üõë Media devices stopped', 'warning');
            }
        }

        async function testPeerConnection() {
            try {
                console.log('üîó Testing WebRTC peer connection...');
                showResult('peerResult', 'üîÑ Creating peer connection...', 'info');

                const configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };

                testPeerConnection = new RTCPeerConnection(configuration);

                // Add local stream if available
                if (testLocalStream) {
                    testLocalStream.getTracks().forEach(track => {
                        testPeerConnection.addTrack(track, testLocalStream);
                    });
                    console.log('‚úÖ Local stream added to peer connection');
                }

                // Handle remote stream
                testPeerConnection.ontrack = (event) => {
                    console.log('üì° Received remote stream');
                    testRemoteStream = event.streams[0];
                    
                    const remoteVideo = document.getElementById('remoteVideo');
                    remoteVideo.srcObject = testRemoteStream;
                    
                    showResult('peerResult', '‚úÖ Remote stream connected!', 'success');
                };

                // Handle ICE candidates
                testPeerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('üßä ICE candidate generated');
                    }
                };

                // Handle connection state changes
                testPeerConnection.onconnectionstatechange = () => {
                    const state = testPeerConnection.connectionState;
                    console.log('üîó Connection state:', state);
                    
                    switch (state) {
                        case 'connected':
                            showResult('peerResult', '‚úÖ Peer connection established!', 'success');
                            updateStatus('Peer Connected', 'success');
                            break;
                        case 'disconnected':
                            showResult('peerResult', '‚ö†Ô∏è Peer connection disconnected', 'warning');
                            break;
                        case 'failed':
                            showResult('peerResult', '‚ùå Peer connection failed', 'error');
                            break;
                    }
                };

                console.log('‚úÖ Peer connection created successfully');
                showResult('peerResult', '‚úÖ Peer connection created successfully', 'success');

            } catch (error) {
                console.error('‚ùå Peer connection error:', error);
                showResult('peerResult', `‚ùå Peer connection failed: ${error.message}`, 'error');
            }
        }

        async function simulateRemoteUser() {
            if (!testPeerConnection) {
                showResult('peerResult', '‚ùå Create peer connection first', 'error');
                return;
            }

            try {
                console.log('üë§ Simulating remote user connection...');
                
                // Create offer
                const offer = await testPeerConnection.createOffer();
                await testPeerConnection.setLocalDescription(offer);
                
                // Simulate remote answer (in real scenario, this comes from signaling server)
                const answer = await testPeerConnection.createAnswer();
                await testPeerConnection.setRemoteDescription(answer);
                
                console.log('‚úÖ Simulated remote user connection');
                showResult('peerResult', '‚úÖ Remote user simulation completed', 'success');
                
            } catch (error) {
                console.error('‚ùå Remote user simulation error:', error);
                showResult('peerResult', `‚ùå Simulation failed: ${error.message}`, 'error');
            }
        }

        function closePeerConnection() {
            if (testPeerConnection) {
                testPeerConnection.close();
                testPeerConnection = null;
                
                const remoteVideo = document.getElementById('remoteVideo');
                remoteVideo.srcObject = null;
                
                console.log('üîó Peer connection closed');
                showResult('peerResult', 'üîó Peer connection closed', 'warning');
            }
        }

        async function runCompleteTest() {
            console.log('üöÄ Running complete integration test...');
            showResult('integrationResult', 'üîÑ Running complete test suite...', 'info');
            
            let results = [];
            
            try {
                // Test 1: Age confirmation
                const ageCheckbox = document.getElementById('ageConfirm');
                if (ageCheckbox.checked) {
                    results.push('‚úÖ Age confirmation: PASS');
                } else {
                    results.push('‚ùå Age confirmation: FAIL (not checked)');
                }
                
                // Test 2: Socket connection
                if (testSocket && testSocket.connected) {
                    results.push('‚úÖ Socket connection: PASS');
                } else {
                    results.push('‚ùå Socket connection: FAIL (not connected)');
                }
                
                // Test 3: Media devices
                if (testLocalStream && testLocalStream.active) {
                    results.push('‚úÖ Media devices: PASS');
                } else {
                    results.push('‚ùå Media devices: FAIL (no stream)');
                }
                
                // Test 4: Peer connection
                if (testPeerConnection && testPeerConnection.connectionState !== 'closed') {
                    results.push('‚úÖ Peer connection: PASS');
                } else {
                    results.push('‚ùå Peer connection: FAIL (not created)');
                }
                
                // Test 5: Connection manager
                if (window.saathiConnection) {
                    results.push('‚úÖ Connection manager: PASS');
                } else {
                    results.push('‚ùå Connection manager: FAIL (not loaded)');
                }
                
                const passCount = results.filter(r => r.includes('‚úÖ')).length;
                const totalTests = results.length;
                
                const resultType = passCount === totalTests ? 'success' : 
                                 passCount > totalTests / 2 ? 'warning' : 'error';
                
                showResult('integrationResult', 
                    `<strong>Integration Test Results (${passCount}/${totalTests} passed):</strong><br>` +
                    results.join('<br>'), 
                    resultType
                );
                
                console.log(`üéØ Integration test completed: ${passCount}/${totalTests} passed`);
                
            } catch (error) {
                console.error('‚ùå Integration test error:', error);
                showResult('integrationResult', `‚ùå Integration test failed: ${error.message}`, 'error');
            }
        }

        function clearAllTests() {
            // Clear all result divs
            ['ageResult', 'googleResult', 'socketResult', 'mediaResult', 'peerResult', 'integrationResult'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            
            // Stop all connections
            stopMediaDevices();
            closePeerConnection();
            disconnectSocket();
            
            console.log('üßπ All tests cleared');
            updateStatus('Tests Cleared', 'info');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîß Connection test page loaded');
            updateStatus('Ready for testing', 'info');
            
            // Check if connection manager is available
            if (window.saathiConnection) {
                console.log('‚úÖ Saathi Connection Manager detected');
            } else {
                console.log('‚ö†Ô∏è Saathi Connection Manager not found');
            }
        });
    </script>
</body>
</html>
